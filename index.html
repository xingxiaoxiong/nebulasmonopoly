<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.rawgit.com/konvajs/konva/2.1.3/konva.min.js"></script>
    <meta charset="utf-8">
    <title>Blockchain Monopoly</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #F0F0F0;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <script src="./js/mapCities.js" ></script>
    <script src="./js/bignumber.js" ></script>
    <script src="./js/utils.js" ></script>
    <script src="./js/nebPay.js"></script>
    <script src="./js/nebulas.js"></script>
    <script src="./js/browserStorage.js"></script>
    <script src="./js/blockchainInterface.js"></script>
    <script src="./js/worldmap.js"></script>
    <script>
        var width = window.innerWidth;
        var height = window.innerHeight;
        var cityCircleRadius = 8
        var cityStrokeWidth = 3
        var state = 0 // 0 for ready to move, 1 for cooling down

        var blockchainInterface = new BlockchainInterface()

        var blockchainCities = {}
        var playerPositions = {}
        var playerPosition
        var validDestCityIds

        var refresh = function() {
            blockchainCities = {}
            playerPositions = {}
            validDestCityIds = new Set()
            
            blockchainInterface.getCities().then(result => {
                if (result.result) {
                    blockchainCities = JSON.parse(result.result);
                    for (var key in mapCities) {
                        var mapCity = mapCities[key];
                        var bcCity = blockchainCities[key]
                        if (bcCity) {
                            mapCity.neighbors = bcCity.neighbors
                            mapCity.owner = bcCity.owner
                            mapCity.price = bcCity.price
                            mapCity.treasure = bcCity.treasure
                            mapCities[key] = mapCity
                        }
                    }
                }
                playerAddress = BrowserStorage.retrieve()
                if (playerAddress == "" || playerAddress == null) {
                    var address = prompt("请输入账户地址", "")
                    if (address != null){
                        BrowserStorage.login(address)
                    } else {
                        playerAddress = ""
                    }
                }
                return blockchainInterface.getPlayerPosition(playerAddress)
            })
            .then(result => {
                if (result.result) {
                    playerPosition = JSON.parse(result.result);
                    // empty string for new players
                    if (playerPosition !== null) {
                        for (var key in mapCities) {
                            var mapCity = mapCities[key]
                            if (mapCity.owner === playerAddress && key != playerPosition) {
                                validDestCityIds.add(key)
                            }
                        }
                        var currentCity = mapCities[playerPosition]
                        if (currentCity) {
                            
                            currentCity.neighbors.forEach(neighborId => {
                                validDestCityIds.add(neighborId)
                            });
                        }
                    } else {
                        for (var key in mapCities) {
                            validDestCityIds.add(key)
                        }
                    }
                }
                refreshDraw()
            })
        }

        function zoomLayer(e, layer)
        {
            e.preventDefault(); var scaleBy = 0.8;

            var oldScale = layer.scaleX();

            var mousePointTo = {
                x: stage.getPointerPosition().x / oldScale - layer.x() / oldScale,
                y: stage.getPointerPosition().y / oldScale - layer.y() / oldScale,
            };

            var newScale = e.deltaY > 0 ? oldScale * scaleBy : oldScale / scaleBy;
            if (newScale < 1.0) {
                return;
            }
            layer.scale({ x: newScale, y: newScale });

            var newPos = {
                x: -(mousePointTo.x - stage.getPointerPosition().x / newScale) * newScale,
                y: -(mousePointTo.y - stage.getPointerPosition().y / newScale) * newScale
            };


            layer.position(newPos);
            layer.draw();
        }

        refresh()
        setInterval(function(){ 
            refresh()
        }, 15000);

        // Konva.js calls
        var stage = new Konva.Stage({
            container: 'container',   
            width: width,
            height: height
        });
        var cityLayer = new Konva.Layer();
        var landLayer = new Konva.Layer();
        var UILayer = new Konva.Layer();

        var changeAccountButton = new Konva.Text({
            x: width - 210,
            y: 10,
            fontFamily: 'Calibri',
            fontSize: 20,
            fill: 'green',
            stroke: 'black',
            strokeWidth: 1,
            shadowColor: 'black',
            shadowBlur: 10,
            shadowOffset: {x : 3, y : 3},
            shadowOpacity: 0.5,
            text: '更换账户'
        })
        changeAccountButton.on('mousedown', function () {
            var address = prompt("请输入账户地址", playerAddress)
            if (address != null){
                BrowserStorage.login(address)
                refresh()
            }
        });

        UILayer.add(changeAccountButton)

        var tooltip = new Konva.Label({
            x: -1000,
            y: -1000,
            opacity: 0.75
        });

        tooltip.add(new Konva.Tag({
            fill: 'black',
            pointerDirection: 'down',
            pointerWidth: 10,
            pointerHeight: 10,
            lineJoin: 'round',
            shadowColor: 'black',
            shadowBlur: 10,
            shadowOffset: 10,
            shadowOpacity: 0.5
        }));

        tooltip.add(new Konva.Text({
            text: '',
            fontFamily: 'Calibri',
            fontSize: 18,
            padding: 5,
            fill: 'white'
        }));

        var gameRuleText = new Konva.Text({
            x: 10,
            y: 10,
            fontFamily: 'Calibri',
            fontSize: 20,
            fill: 'green',
            stroke: 'black',
            strokeWidth: 1,
            shadowColor: 'black',
            shadowBlur: 10,
            shadowOffset: {x : 3, y : 3},
            shadowOpacity: 0.5,
            text: '游戏规则'
        });
        gameRuleText.on('mousedown', function () {
            window.open('https://xingxiaoxiong.github.io/nebulasmonopolyhelp');
        });

        var infoLayer = new Konva.Layer();
        infoLayer.add(tooltip);
        infoLayer.add(gameRuleText);
        stage.add(landLayer);
        stage.add(cityLayer);
        stage.add(infoLayer);
        stage.add(UILayer);

        stage.addEventListener('wheel', (e) => {
            zoomLayer(e, landLayer);
            zoomLayer(e, cityLayer);
        });
        
        var drawLand = function() {
            lands.forEach(land => {
                var points = []
                land.forEach(point => {
                    let coord = lonlat2coord(point[0], point[1])
                    points.push(coord[0])
                    points.push(coord[1])
                });
                var line = new Konva.Line({
                    points: points,
                    stroke: 'grey',
                    strokeWidth: cityStrokeWidth,
                    lineCap: 'round',
                    lineJoin: 'round'
                });
                landLayer.add(line);
            });
            landLayer.draw()
        }
        drawLand()


        var refreshDraw = function() {
            cityLayer.clear()

            for (var key in mapCities) {
                var mapCityInfo = mapCities[key];
                var coord = lonlat2coord(mapCityInfo.lon, mapCityInfo.lat)
                var neighbors = mapCityInfo.neighbors;
                neighbors.forEach(cityId => {
                    var otherCityInfo = mapCities[cityId]
                    var targetCoord = lonlat2coord(otherCityInfo.lon, otherCityInfo.lat)
                    var line = new Konva.Line({
                        points: [coord[0], coord[1], targetCoord[0], targetCoord[1]],
                        stroke: 'black',
                        strokeWidth: cityStrokeWidth,
                        lineCap: 'round',
                        lineJoin: 'round'
                    });
                    cityLayer.add(line);
                });
            }

            for (var key in mapCities) {
                var mapCityInfo = mapCities[key];
                var coord = lonlat2coord(mapCityInfo.lon, mapCityInfo.lat)
                var cityIcon = new Konva.Circle({
                    x: coord[0],
                    y: coord[1],
                    radius: cityCircleRadius,
                    fill: 'white',
                    stroke: 'black',
                    strokeWidth: cityStrokeWidth,
                    id: key,
                    name: 'cityIcon'
                });

                if (mapCityInfo.owner === playerAddress) {
                    cityIcon = new Konva.Star({
                        x: coord[0],
                        y: coord[1],
                        numPoints: 5,
                        innerRadius: cityCircleRadius,
                        outerRadius: cityCircleRadius * 1.5,
                        fill: '#f441c4',
                        stroke: 'black',
                        strokeWidth: cityStrokeWidth
                    });
                }

                (function (cityId) { 
                    cityIcon.on('mouseover', function(){
                        var city = mapCities[cityId]
                        var coord = lonlat2coord(city.lon, city.lat)
                        var msg = city.name + '\n价格: ' + BlockchainInterface.basicToNas(city.price) + ' NAS\n市长: '; 
                        if (city.owner) {
                            msg += city.owner + '\n';
                        } else {
                            msg += '还没有市长。\n'
                        }
                        msg += '宝藏: ' + BlockchainInterface.basicToNas(city.treasure) + ' NAS\n';
                        var text = tooltip.getText()
                        text.setText(msg)
                        tooltip.x(coord[0])
                        tooltip.y(coord[1])
                        infoLayer.draw()
                    })
                    cityIcon.on('mouseout', function(){
                        tooltip.x(-1000)
                        tooltip.y(-1000)
                        infoLayer.draw()
                    })
                }) (key); 

                if (mapCityInfo.owner && mapCityInfo.owner != playerAddress) {
                    cityIcon.fill('red')
                }
                
                if (key == playerPosition) {
                    cityIcon.fill('#4286f4')

                    if (mapCityInfo.treasure > 0) {
                        (function (cityId) {
                            cityIcon.on('mousedown', function(){
                                if (confirm("捡起宝藏")) {
                                    blockchainInterface.claimTreasure(cityId, function() {
                                        console.log('claimed treasure!!!')
                                    })
                                }
                            })   
                        }) (key);  
                    } else if (mapCityInfo.owner !== playerAddress) {
                        (function (cityId) {
                            var cityInfo = mapCities[cityId];
                            var cityPrice = BlockchainInterface.basicToNas(cityInfo.price)
                            cityIcon.on('mousedown', function(){
                                if (confirm("支付 " + cityPrice + " NAS 成为该市市长")) {
                                    blockchainInterface.buy(cityId, cityPrice, function() {
                                        console.log('Bought it!!!')
                                    })
                                }
                            })   
                        }) (key); 
                    }
                }

                if (validDestCityIds.has(key)) {
                    (function (cityId) { 
                        cityIcon.on('mousedown', function(){
                            var cityInfo = mapCities[cityId]
                            var cityPrice = BlockchainInterface.basicToNas(cityInfo.price)
                            var confirmText = '确定移动到 ' + cityInfo.name + '？\n';
                            if (cityInfo.owner && cityInfo.owner != playerAddress) {
                                confirmText += cityInfo.name + ' 已经有了主人，需要支付 ' + cityPrice.times(0.01) + ' NAS 作为过路费'
                            }
                            if (confirm(confirmText)) {
                                if (key !== playerPosition) { // unnecessary if check
                                    blockchainInterface.moveTo(cityId, function() {
                                        console.log('moved!!!')
                                    })
                                }
                            }
                        })
                    }) (key); 
                }
                
                if (mapCityInfo.treasure > 0) {
                    cityIcon.stroke('#f49d41')
                }
                cityLayer.add(cityIcon);

            }
            cityLayer.draw()
        }

        window.addEventListener("keydown", keyDownTextField, false);

        function keyDownTextField(e) {
            var keyCode = e.keyCode;
            if(keyCode === 27) {
                var helpText = '1. You can move to any city which is directly connected to the city you are in.\n2. You can move to any city that you own.\n3. If you move to any city which is owned by another player, you need to pay that player toll fees.\n4. Cities which are outlined with orange contains a treasure. You need to first arrive at that city and then claim it.\n'
                confirm(helpText)
            } 
        }

        document.addEventListener('DOMContentLoaded', function() {
            if(typeof(webExtensionWallet) === "undefined"){
                if (window.confirm('请安装星云链的Chrome钱包扩展.')) {
                    window.open('https://github.com/ChengOrangeJu/WebExtensionWallet');
                }
            }
        }, false);
    </script>

</body>
</html>